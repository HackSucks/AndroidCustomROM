name: LXDE Desktop via noVNC + Cloudflare

on: workflow_dispatch

jobs:
  desktop:
    runs-on: ubuntu-latest
    steps:
      - name: Install LXDE and noVNC
        run: |
          sudo apt update
          sudo apt install -y lxde-core lxterminal tightvncserver novnc websockify wget
          mkdir -p ~/.vnc
          echo "password" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

      - name: Start VNC server + noVNC
        run: |
          export DISPLAY=:1
          vncserver :1 -geometry 1280x720 -depth 24
          nohup websockify --web=/usr/share/novnc/ 6080 localhost:5901 &

      - name: Download Cloudflared
        run: |
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Run Cloudflared tunnel (blocking)
        run: |
          echo "‚úÖ LXDE Desktop is running!"
          echo "‚û°Ô∏è The public URL will appear below (https://*.trycloudflare.com)."
          echo "üõë Leave this running and stop the workflow manually when finished."
          
          # Keep-alive in background (prints heartbeat every 5 min)
          nohup python3 -u -c "import time; \
            import sys; \
            i=0; \
            print('‚è≥ Keep-alive started...'); \
            sys.stdout.flush(); \
            while True: \
                i+=1; \
                print(f'Heartbeat {i} (still alive)'); \
                sys.stdout.flush(); \
                time.sleep(300)" &

          # Run cloudflared in the foreground (keeps job alive)
          cloudflared tunnel --url http://localhost:6080 --no-autoupdate
